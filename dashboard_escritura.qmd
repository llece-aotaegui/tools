--- 
title: "Gantt Prueba de Escritura"
#author: "Álvaro Otaegui"
format: dashboard
execute:
  echo: false
--- 

```{r}
# Setting
library(tidyverse)
library(dplyr)
library(readxl)
library(plotly)

## Carga de datos
df <- readxl::read_xlsx("fechas.xlsx")
df <- df |>
    mutate(cap_inicio = as.Date(capacitacion_inicio, format = "%Y/%m/%d")) |>
    mutate(cap_termino = as.Date(capacitacion_termino, format = "%Y/%m/%d")) |>
    mutate(cap_duracion = cap_termino - cap_inicio) |>
    mutate(mb_inicio = as.Date(mb_inicio, format = "%Y/%m/%d")) |>
    mutate(mb_termino = as.Date(mb_termino, format = "%Y/%m/%d")) |>
    mutate(mb_duracion = mb_termino - mb_inicio) |>
    mutate(cor_inicio = as.Date(correccion_inicio, format = "%Y/%m/%d")) |>
    mutate(cor_termino = as.Date(correccion_termino, format = "%Y/%m/%d")) |>
    mutate(cor_duracion = cor_termino - cor_inicio) |>
    filter(pais != "Ecuador (Costa Galápagos)")

# Fecha actual (se actualiza cada vez que renderizas el documento)
fecha_actual <- Sys.Date()

# Función helper para crear el gráfico Gantt
crear_gantt <- function(df, fecha_inicio, fecha_termino, duracion) {
  fig <- plot_ly()
  
  for(i in 1:(nrow(df) - 1)){
    fig <- add_trace(fig,
                     x = c(df[[fecha_inicio]][i], df[[fecha_inicio]][i] + df[[duracion]][i]),
                     y = c(i, i),
                     mode = "lines",
                     line = list(color = df$color[i], width = 20),
                     showlegend = FALSE,
                     hoverinfo = "text",
                     text = paste("País: ", df$pais[i], "<br>",
                                  "Días: ", df[[duracion]][i], "days<br>",
                                  "Fecha de término: ", df[[fecha_termino]][i]),
                     evaluate = TRUE)
  }
  
  fig <- layout(fig, 
                xaxis = list(
                  title = "Fecha",
                  type = "date",
                  tickformat = "%d/%m/%Y"
                ),
                yaxis = list(
                  tickmode = "array", 
                  tickvals = 1:nrow(df), 
                  ticktext = unique(df$pais),
                  domain = c(0, 0.9)
                ),
                shapes = list(
                  list(
                    type = "line",
                    x0 = fecha_actual,
                    x1 = fecha_actual,
                    y0 = 0,
                    y1 = 1,
                    yref = "paper",
                    line = list(
                      color = "red",
                      width = 2,
                      dash = "dash"
                    ),
                    name = "Fecha actual"
                  )
                ))
  
  return(fig)
}
```

# Capacitación
```{r}
crear_gantt(df, "cap_inicio", "cap_termino", "cap_duracion")
```

# Marcha Blanca
```{r}
crear_gantt(df, "mb_inicio", "mb_termino", "mb_duracion")
```

# Corrección Prueba de Escritura
```{r}
crear_gantt(df, "cor_inicio", "cor_termino", "cor_duracion")
```